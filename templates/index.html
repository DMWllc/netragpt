<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jovira - Your Intelligent Assistant</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
    :root {
        --whatsapp-green: #128C7E;
        --whatsapp-green-dark: #075E54;
        --whatsapp-green-light: #25D366;
        --whatsapp-blue: #34B7F1;
        --whatsapp-gray-light: #ECE5DD;
        --whatsapp-gray: #DCF8C6;
        --whatsapp-gray-dark: #B3B3B3;
        --whatsapp-white: #FFFFFF;
        --whatsapp-black: #2A2F32;
        --border-radius: 10px;
        --border-radius-small: 8px;
        --transition: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #e5ddd5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        color: #333;
        overflow: hidden;
        padding: 0;
        position: relative;
    }

    /* WhatsApp-style background pattern */
    .chat-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://myaidnest.com/images/netrawallpaper.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0.1;
        z-index: -1;
    }

    /* Main Chat Container */
    .chat-container {
        background: var(--whatsapp-white);
        width: 100%;
        max-width: 450px;
        height: 100vh;
        max-height: 850px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }

    /* Header */
    .chat-header {
        background: var(--whatsapp-green);
        color: white;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        z-index: 10;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .back-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: none;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-fallback {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        color: white;
        background: var(--whatsapp-green-dark);
    }

    .user-details h3 {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 2px;
    }

    .user-details p {
        font-size: 12px;
        opacity: 0.8;
    }

    .header-right {
        display: flex;
        gap: 10px;
    }

    .header-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: var(--transition);
    }

    .header-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Chat Content */
    .chat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: transparent;
        position: relative;
    }

    #chat {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scroll-behavior: smooth;
    }

    #chat::-webkit-scrollbar {
        width: 6px;
    }

    #chat::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
    }

    #chat::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }

    /* Messages */
    .message {
        display: flex;
        margin-bottom: 4px;
        animation: messageSlide 0.3s ease-out;
        gap: 8px;
        align-items: flex-start;
        max-width: 85%;
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message.bot {
        align-self: flex-start;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        flex-shrink: 0;
        overflow: hidden;
        margin-top: 2px;
    }

    .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-fallback {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        color: white;
        background: var(--whatsapp-green);
    }

    .message.user .message-avatar {
        background: var(--whatsapp-green);
    }

    .message.bot .message-avatar {
        background: var(--whatsapp-blue);
    }

    .message-content {
        padding: 8px 12px;
        border-radius: var(--border-radius);
        font-size: 14px;
        line-height: 1.4;
        position: relative;
        transition: var(--transition);
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        max-width: 100%;
    }

    .message.user .message-content {
        background: var(--whatsapp-gray);
        color: var(--whatsapp-black);
        border-top-right-radius: 0;
    }

    .message.bot .message-content {
        background: white;
        color: var(--whatsapp-black);
        border-top-left-radius: 0;
        border: 1px solid rgba(0,0,0,0.05);
        
        /* Scrollable properties for Jovira's messages */
        overflow-x: auto;
        overflow-y: auto;
        max-height: 500px;
        max-width: 100%;
        word-wrap: break-word;
        white-space: pre-wrap;
        
        /* Always show scrollbars */
        scrollbar-width: thin;
        scrollbar-color: var(--whatsapp-green) rgba(255, 255, 255, 0.05);
    }

    /* Custom scrollbar for Jovira's messages */
    .message.bot .message-content::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .message.bot .message-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
    }

    .message.bot .message-content::-webkit-scrollbar-thumb {
        background: var(--whatsapp-green);
        border-radius: 3px;
        opacity: 0.7;
    }

    .message.bot .message-content::-webkit-scrollbar-thumb:hover {
        opacity: 1;
    }

    .message-time {
        font-size: 11px;
        color: rgba(0,0,0,0.45);
        text-align: right;
        margin-top: 4px;
        display: block;
    }

    .message.user .message-time {
        text-align: right;
    }

    .message.bot .message-time {
        text-align: left;
    }

    /* Uploaded Images */
    .uploaded-image {
        max-width: 100%;
        max-height: 250px;
        border-radius: var(--border-radius-small);
        margin-top: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .uploaded-image:hover {
        opacity: 0.9;
    }

    /* Voice Recording */
    .voice-recording {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: var(--whatsapp-green);
        border-radius: var(--border-radius);
        margin: 8px 0;
        animation: pulse 1.5s infinite;
        color: white;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .voice-visualizer {
        display: flex;
        gap: 3px;
        align-items: center;
        flex: 1;
    }

    .voice-bar {
        width: 3px;
        background: white;
        border-radius: 2px;
        animation: voicePulse 0.8s infinite ease-in-out;
    }

    .voice-bar:nth-child(1) { animation-delay: 0s; height: 8px; }
    .voice-bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
    .voice-bar:nth-child(3) { animation-delay: 0.2s; height: 16px; }
    .voice-bar:nth-child(4) { animation-delay: 0.3s; height: 12px; }
    .voice-bar:nth-child(5) { animation-delay: 0.4s; height: 8px; }

    @keyframes voicePulse {
        0%, 100% { transform: scaleY(0.8); }
        50% { transform: scaleY(1.2); }
    }

    /* Links Styling */
    .message-link {
        color: var(--whatsapp-green);
        text-decoration: none;
        border-bottom: 1px solid var(--whatsapp-green);
        transition: var(--transition);
        padding: 2px 4px;
        border-radius: 4px;
    }

    .message-link:hover {
        background: var(--whatsapp-green);
        color: white;
    }

    /* Enhanced Code Blocks */
    .code-block {
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 0;
        margin: 12px 0;
        position: relative;
        font-family: 'Fira Code', monospace;
        font-size: 13px;
        line-height: 1.4;
        overflow: hidden;
    }

    .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid #e0e0e0;
    }

    .code-language {
        color: var(--whatsapp-green);
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .code-actions {
        display: flex;
        gap: 8px;
    }

    .code-btn {
        background: rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.2);
        color: #555;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .code-btn:hover {
        background: var(--whatsapp-green);
        color: white;
    }

    .code-btn.run-btn {
        background: var(--whatsapp-green-light);
        color: white;
    }

    .code-btn.copy-btn {
        background: var(--whatsapp-blue);
        color: white;
    }

    .code-content {
        padding: 12px;
        color: #333;
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
    }

    .code-content pre {
        margin: 0;
        font-family: 'Fira Code', monospace;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .code-keyword { color: #d73a49; }
    .code-string { color: #032f62; }
    .code-number { color: #005cc5; }
    .code-comment { color: #6a737d; font-style: italic; }
    .code-function { color: #6f42c1; }
    .code-operator { color: #d73a49; }
    .code-variable { color: #e36209; }
    .code-class { color: #6f42c1; font-weight: bold; }

    /* Inline Code */
    .inline-code {
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 2px 4px;
        font-family: 'Fira Code', monospace;
        font-size: 12px;
        color: #d73a49;
    }

    /* Enhanced Math Expression Styling */
    .math-expression {
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        text-align: center;
        font-size: 16px;
        font-family: 'Fira Code', monospace;
    }

    .math-result {
        background: var(--whatsapp-green-light);
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        margin: 8px 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'Fira Code', monospace;
    }

    .math-result::before {
        content: 'ðŸ§®';
        font-size: 16px;
    }

    .math-calculation {
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        font-family: 'Fira Code', monospace;
        font-size: 16px;
    }

    .math-step {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .math-step:last-child {
        border-bottom: none;
    }

    .math-expression-symbols {
        font-size: 16px;
        font-weight: 600;
    }

    .math-equals {
        color: var(--whatsapp-green);
        margin: 0 10px;
    }

    /* LaTeX Equation Styling */
    .latex-equation {
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 16px;
        margin: 12px 0;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 8px;
    }

    .latex-equation img {
        max-width: 100%;
        max-height: 180px;
        border-radius: 6px;
    }

    .latex-source {
        font-family: 'Fira Code', monospace;
        font-size: 12px;
        color: #666;
        background: rgba(0, 0, 0, 0.05);
        padding: 6px 10px;
        border-radius: 6px;
        margin-top: 8px;
        word-break: break-all;
    }

    /* Mathematical Visualization */
    .math-visualization {
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
        text-align: center;
    }

    .math-visualization img {
        max-width: 100%;
        max-height: 250px;
        border-radius: 8px;
    }

    .visualization-title {
        font-size: 14px;
        color: var(--whatsapp-green);
        margin-bottom: 8px;
        font-weight: 600;
    }

    /* Chat Lock Overlay */
    .chat-lock {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        color: var(--whatsapp-black);
        text-align: center;
        padding: 30px;
    }

    .lock-icon {
        font-size: 48px;
        margin-bottom: 20px;
        color: var(--whatsapp-green);
    }

    .lock-message {
        font-size: 16px;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .session-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .session-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .session-btn.primary {
        background: var(--whatsapp-green);
        color: white;
    }

    .session-btn.secondary {
        background: rgba(0, 0, 0, 0.1);
        color: var(--whatsapp-black);
        border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .session-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Typing Indicator */
    .message-typing {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: white;
        border-radius: var(--border-radius);
        border-top-left-radius: 0;
        max-width: 85%;
        align-self: flex-start;
        color: #666;
        font-size: 13px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--whatsapp-green);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Welcome Message */
    .welcome-message {
        text-align: center;
        padding: 20px;
        color: #666;
        background: white;
        border-radius: var(--border-radius);
        margin: 10px 0;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .welcome-message i {
        font-size: 32px;
        margin-bottom: 12px;
        color: var(--whatsapp-green);
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .quick-action {
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: var(--whatsapp-black);
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
    }

    .quick-action:hover {
        background: var(--whatsapp-green);
        color: white;
    }

    /* IMPROVED Chat Input - WhatsApp Style */
    .chat-input-area {
        border-top: 1px solid rgba(0,0,0,0.1);
        background: var(--whatsapp-white);
        padding: 10px 16px;
        position: relative;
    }

    .chat-input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        background: white;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 24px;
        padding: 6px 12px;
        transition: var(--transition);
    }

    /* FIXED: Remove inner border when input is focused */
    .chat-input-wrapper:focus-within {
        border-color: var(--whatsapp-green);
        box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.2);
    }

    .chat-input-wrapper.typing {
        border-color: var(--whatsapp-green);
        box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.2);
    }

    .input-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0;
    }

    .file-input-wrapper {
        position: relative;
    }

    .file-input {
        position: absolute;
        left: -9999px;
        opacity: 0;
    }

    .input-btn {
        background: transparent;
        border: none;
        color: #666;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }

    .input-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--whatsapp-black);
    }

    .voice-btn.recording {
        background: #ff4757;
        color: white;
        animation: pulse 1.5s infinite;
    }

    /* FIXED: Remove inner border on textarea focus */
    #input {
        flex: 1;
        border: none;
        font-size: 14px;
        background: transparent;
        color: var(--whatsapp-black);
        transition: var(--transition);
        resize: none;
        min-height: 20px;
        max-height: 100px;
        font-family: inherit;
        line-height: 1.4;
        padding: 8px 0;
        outline: none; /* This removes the inner border */
    }

    #input:focus {
        outline: none; /* Ensure no outline appears on focus */
    }

    #input::placeholder {
        color: #999;
    }

    #send {
        padding: 8px;
        background: var(--whatsapp-green);
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 50%;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        flex-shrink: 0;
    }

    #send:hover {
        background: var(--whatsapp-green-dark);
    }

    #send:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .send-icon {
        width: 16px;
        height: 16px;
    }

    /* Image Display */
    .message-image {
        max-width: 100%;
        max-height: 250px;
        border-radius: var(--border-radius-small);
        margin-top: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .message-image:hover {
        opacity: 0.9;
    }

    /* Image Modal */
    .image-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
    }

    .image-modal.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
        border-radius: var(--border-radius);
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        transition: var(--transition);
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Chats Sidebar */
    .chats-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 1000;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .chats-sidebar.active {
        left: 0;
    }

    .sidebar-header {
        background: var(--whatsapp-green);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-title {
        color: white;
        font-weight: 600;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .close-sidebar {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: var(--transition);
    }

    .close-sidebar:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .chats-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .chat-item {
        background: white;
        border-radius: var(--border-radius-small);
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: var(--transition);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .chat-item:hover {
        background: #f5f5f5;
    }

    .chat-item.active {
        background: var(--whatsapp-gray);
        border-color: rgba(18, 140, 126, 0.2);
    }

    .chat-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }

    .chat-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--whatsapp-black);
    }

    .chat-date {
        font-size: 11px;
        color: #999;
    }

    .chat-preview {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .no-chats {
        text-align: center;
        color: #999;
        padding: 60px 20px;
        font-style: italic;
    }

    .no-chats i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    /* Toast Notifications */
    .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--whatsapp-green);
        color: white;
        padding: 12px 20px;
        border-radius: var(--border-radius-small);
        z-index: 1000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 8px;
        animation: toastSlide 0.3s ease-out;
    }

    @keyframes toastSlide {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* Session Timer */
    .session-timer {
        position: absolute;
        top: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: var(--whatsapp-black);
        padding: 6px 12px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 20px;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-width: 180px;
        z-index: 10;
        transition: var(--transition);
    }

    .timer-info {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .timer-progress {
        flex: 1;
        height: 4px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin: 0 8px;
    }

    .timer-progress-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
    }

    .timer-actions {
        display: flex;
        gap: 6px;
    }

    .timer-btn {
        background: rgba(0, 0, 0, 0.05);
        border: none;
        color: var(--whatsapp-black);
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 10px;
        cursor: pointer;
        transition: var(--transition);
    }

    .timer-btn:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
        body {
            padding: 0;
        }
        
        .chat-container {
            height: 100vh;
            max-width: none;
        }

        .chat-header {
            padding: 8px 12px;
        }

        #chat {
            padding: 15px;
        }

        .message-content {
            max-width: 80%;
            padding: 8px 12px;
        }

        .chat-input-area {
            padding: 8px 12px;
        }

        .chats-sidebar {
            width: 100%;
        }

        .input-controls {
            gap: 6px;
        }

        .input-btn {
            width: 32px;
            height: 32px;
            padding: 6px;
        }

        #send {
            width: 32px;
            height: 32px;
            padding: 6px;
        }

        .session-timer {
            top: -30px;
            min-width: 160px;
            font-size: 11px;
        }

        .latex-equation {
            padding: 10px;
        }

        .math-visualization {
            padding: 10px;
        }
    }

    @media (min-width: 768px) {
        .chat-container {
            max-width: 450px;
            height: 800px;
            border-radius: 10px;
            overflow: hidden;
        }

        .chats-sidebar {
            width: 400px;
            left: -400px;
        }
    }

    @media screen and (max-width: 768px) {
        input, textarea {
            font-size: 16px !important;
        }
    }

    /* Enhanced selection */
    .message-content::selection {
        background: var(--whatsapp-green);
        color: white;
    }

    /* Focus states for accessibility */
    button:focus-visible {
        outline: 2px solid var(--whatsapp-green);
        outline-offset: 2px;
    }

    /* MathJax styling */
    .mjx-chtml {
        outline: none;
    }

    mjx-container {
        text-align: center !important;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
</head>
<body>
    <!-- WhatsApp-style background -->
    <div class="chat-background"></div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
        <button class="modal-close" id="modalClose">
            <i class="fas fa-times"></i>
        </button>
        <img class="modal-content" id="modalImage" src="" alt="Enlarged view">
    </div>

    <!-- Chats Sidebar -->
    <div class="chats-sidebar" id="chatsSidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-comments"></i> Your Conversations
            </div>
            <button class="close-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chats-list" id="chatsList">
            <!-- Chats will be dynamically loaded here -->
        </div>
    </div>

    <!-- Main Chat Container -->
    <div class="chat-container">
        <!-- Session Timer Bar -->
        <div class="session-timer" id="sessionTimer">
            <div class="timer-info">
                <i class="fas fa-clock"></i>
                <span id="timerText">20:00</span>
            </div>
            <div class="timer-progress">
                <div class="timer-progress-bar" id="timerProgress" style="width: 100%; background: var(--whatsapp-green);"></div>
            </div>
            <div class="timer-actions">
                <button class="timer-btn" id="extendSession" title="Extend Session">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="timer-btn" id="pauseSession" title="Pause Session">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
        </div>

        <!-- Chat Lock Overlay -->
        <div class="chat-lock" id="chatLock" style="display: none;">
            <div class="lock-icon">
                <i class="fas fa-hourglass-end"></i>
            </div>
            <h3>Session Expired</h3>
            <p class="lock-message">Your 20-minute chat session has ended. Start a new session to continue chatting with Jovira.</p>
            <div class="session-actions">
                <button class="session-btn primary" onclick="startNewSession()">
                    <i class="fas fa-plus"></i> Start New Session
                </button>
                <button class="session-btn secondary" onclick="viewChatHistory()">
                    <i class="fas fa-history"></i> View History
                </button>
            </div>
        </div>

        <div class="chat-header">
            <div class="header-left">
                <button class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="user-info">
                    <div class="user-avatar">
                        <img src="https://myaidnest.com/images/jovira.png" alt="Jovira" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback" style="display: none;">J</div>
                    </div>
                    <div class="user-details">
                        <h3>Jovira</h3>
                        <p>Online</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="videoCallBtn" title="Video Call">
                    <i class="fas fa-video"></i>
                </button>
                <button class="header-btn" id="voiceCallBtn" title="Voice Call">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="header-btn" id="menuBtn" title="Menu">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-content">
            <div id="chat">
                <div class="welcome-message">
                    <i class="fas fa-robot"></i>
                    <h3 style="margin-bottom: 8px; color: var(--whatsapp-black);">Hello! I'm Jovira</h3>
                    <p style="margin-bottom: 15px; line-height: 1.5;">Your intelligent assistant from Aidnest Africa! I can help you with:</p>
                    
                    <div class="quick-actions">
                        <div class="quick-action" onclick="askQuestion('Calculate 25 Ã— 4 + 15')">
                            <i class="fas fa-calculator"></i> Math
                        </div>
                        <div class="quick-action" onclick="askQuestion('Show me Python code for a calculator')">
                            <i class="fas fa-code"></i> Code
                        </div>
                        <div class="quick-action" onclick="askQuestion('Tell me about Netra services')">
                            <i class="fas fa-mobile-alt"></i> Netra
                        </div>
                        <div class="quick-action" onclick="askQuestion('What is 15% of 200?')">
                            <i class="fas fa-percentage"></i> Percentage
                        </div>
                    </div>
                    
                    <p style="font-size: 12px; opacity: 0.8; margin-top: 10px;">
                        ðŸ’¡ <strong>New Features:</strong> Session management, code execution, math calculations!
                    </p>
                    <p style="font-size: 12px; opacity: 0.8; margin-top: 10px;">
                        Ask me anything about technology, coding, or our services! ðŸ’«
                    </p>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="chat-input-wrapper" id="inputWrapper">
                <div class="input-controls">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageUpload" accept="image/*" class="file-input">
                        <button class="input-btn" id="imageBtn" title="Upload Image">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <button class="input-btn" id="emojiBtn" title="Emoji">
                        <i class="far fa-smile"></i>
                    </button>
                </div>
                <textarea id="input" placeholder="Type a message..." rows="1"></textarea>
                <div class="input-controls">
                    <button class="input-btn voice-btn" id="voiceBtn" title="Voice Message">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="send">
                        <i class="fas fa-paper-plane send-icon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatBox = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const backBtn = document.getElementById('backBtn');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const voiceCallBtn = document.getElementById('voiceCallBtn');
        const menuBtn = document.getElementById('menuBtn');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const chatsSidebar = document.getElementById('chatsSidebar');
        const chatsList = document.getElementById('chatsList');
        const imageUpload = document.getElementById('imageUpload');
        const imageBtn = document.getElementById('imageBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalClose = document.getElementById('modalClose');
        const inputWrapper = document.getElementById('inputWrapper');
        const sessionTimer = document.getElementById('sessionTimer');
        const timerText = document.getElementById('timerText');
        const timerProgress = document.getElementById('timerProgress');
        const extendSessionBtn = document.getElementById('extendSession');
        const pauseSessionBtn = document.getElementById('pauseSession');
        const chatLock = document.getElementById('chatLock');

        // Profile images
        const JOVIRA_AVATAR = 'https://myaidnest.com/images/jovira.png';
        const USER_AVATAR = 'https://myaidnest.com/images/user.png';

        // State
        let currentChatId = null;
        let isTyping = false;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let isSessionActive = true;
        let sessionTimeRemaining = 20 * 60; // 20 minutes in seconds
        let sessionTimerInterval = null;
        let isSessionPaused = false;

        // Initialize chat system
        function initializeChatSystem() {
            const savedChats = getChatsList();
            if (savedChats.length === 0) {
                createNewChat();
            } else {
                currentChatId = savedChats[0].id;
                loadChatHistory(currentChatId);
            }
            updateChatsList();
            setupEventListeners();
            initializeSessionManagement();
        }

        // Initialize session management
        function initializeSessionManagement() {
            // Check if there's a saved session
            const savedSession = localStorage.getItem('jovira_session');
            if (savedSession) {
                const sessionData = JSON.parse(savedSession);
                if (sessionData.expires > Date.now()) {
                    sessionTimeRemaining = Math.floor((sessionData.expires - Date.now()) / 1000);
                    isSessionActive = true;
                    startSessionTimer();
                } else {
                    isSessionActive = false;
                    chatLock.style.display = 'flex';
                    sessionTimer.style.display = 'none';
                }
            } else {
                // Start a new session
                startNewSession();
            }
        }

        // Start new session
        function startNewSession() {
            isSessionActive = true;
            sessionTimeRemaining = 20 * 60; // 20 minutes
            chatLock.style.display = 'none';
            sessionTimer.style.display = 'flex';
            
            // Save session to localStorage
            const sessionData = {
                expires: Date.now() + (sessionTimeRemaining * 1000)
            };
            localStorage.setItem('jovira_session', JSON.stringify(sessionData));
            
            startSessionTimer();
            updateTimerDisplay();
            showToast('New session started! ðŸŽ‰');
        }

        // Start session timer
        function startSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }
            
            sessionTimerInterval = setInterval(() => {
                if (!isSessionPaused && isSessionActive) {
                    sessionTimeRemaining--;
                    updateTimerDisplay();
                    
                    if (sessionTimeRemaining <= 0) {
                        endSession();
                    }
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(sessionTimeRemaining / 60);
            const seconds = sessionTimeRemaining % 60;
            timerText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            const progressPercentage = (sessionTimeRemaining / (20 * 60)) * 100;
            timerProgress.style.width = `${progressPercentage}%`;
            
            // Update color based on time remaining
            if (progressPercentage <= 25) {
                timerProgress.style.background = '#ff4757';
            } else if (progressPercentage <= 50) {
                timerProgress.style.background = '#ffa502';
            } else {
                timerProgress.style.background = 'var(--whatsapp-green)';
            }
        }

        // End session
        function endSession() {
            isSessionActive = false;
            clearInterval(sessionTimerInterval);
            chatLock.style.display = 'flex';
            sessionTimer.style.display = 'none';
            localStorage.removeItem('jovira_session');
            showToast('Session ended. Start a new session to continue.');
        }

        // Extend session
        function extendSession() {
            if (isSessionActive) {
                sessionTimeRemaining += 10 * 60; // Add 10 minutes
                updateTimerDisplay();
                
                // Update session in localStorage
                const sessionData = {
                    expires: Date.now() + (sessionTimeRemaining * 1000)
                };
                localStorage.setItem('jovira_session', JSON.stringify(sessionData));
                
                showToast('Session extended by 10 minutes! â°');
            }
        }

        // Toggle session pause
        function toggleSessionPause() {
            isSessionPaused = !isSessionPaused;
            
            if (isSessionPaused) {
                pauseSessionBtn.innerHTML = '<i class="fas fa-play"></i>';
                pauseSessionBtn.title = 'Resume Session';
                showToast('Session paused');
            } else {
                pauseSessionBtn.innerHTML = '<i class="fas fa-pause"></i>';
                pauseSessionBtn.title = 'Pause Session';
                showToast('Session resumed');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Image upload handling
            imageBtn.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleImageUpload);
            
            // Voice recording
            voiceBtn.addEventListener('click', toggleVoiceRecording);
            
            // Image modal
            modalClose.addEventListener('click', closeImageModal);
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) closeImageModal();
            });
            
            // Input typing state
            input.addEventListener('input', handleInputTyping);
            input.addEventListener('focus', () => {
                inputWrapper.classList.add('typing');
            });
            input.addEventListener('blur', () => {
                if (!input.value.trim()) {
                    inputWrapper.classList.remove('typing');
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    input.focus();
                }
            });

            // Menu button
            menuBtn.addEventListener('click', showSidebar);
            
            // Timer controls
            extendSessionBtn.addEventListener('click', extendSession);
            pauseSessionBtn.addEventListener('click', toggleSessionPause);
        }

        // Handle input typing state
        function handleInputTyping() {
            if (input.value.trim()) {
                inputWrapper.classList.add('typing');
            } else {
                inputWrapper.classList.remove('typing');
            }
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file!');
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size should be less than 5MB!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                addMessage("User", "I uploaded an image for analysis:", imageData);
                
                // Analyze the image
                analyzeImage(file);
            };
            reader.readAsDataURL(file);

            // Reset file input
            event.target.value = '';
        }

        // Analyze uploaded image
        async function analyzeImage(file) {
            showTypingIndicator();
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/analyze_image', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.analysis) {
                    addMessage("Bot", `${data.message}\n\n${data.analysis}`);
                } else if (data.error) {
                    addMessage("Bot", `Sorry, I encountered an error while analyzing the image: ${data.error}`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage("Bot", "Sorry, I encountered an error while analyzing the image. Please try again.");
            }
        }

        // Voice recording functionality
        async function toggleVoiceRecording() {
            if (!isRecording) {
                await startVoiceRecording();
            } else {
                stopVoiceRecording();
            }
        }

        // Start voice recording
        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudioRecording(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                
                // Add recording indicator to chat
                addVoiceRecordingIndicator();
                
            } catch (error) {
                console.error('Error starting voice recording:', error);
                showToast('Microphone access denied or not available');
            }
        }

        // Stop voice recording
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                
                // Remove recording indicator
                removeVoiceRecordingIndicator();
            }
        }

        // Add voice recording indicator
        function addVoiceRecordingIndicator() {
            const recordingDiv = document.createElement('div');
            recordingDiv.className = 'voice-recording';
            recordingDiv.id = 'voice-recording-indicator';
            recordingDiv.innerHTML = `
                <i class="fas fa-microphone"></i>
                <div class="voice-visualizer">
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                </div>
                <span>Recording... Click stop when done</span>
            `;
            chatBox.appendChild(recordingDiv);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        // Remove voice recording indicator
        function removeVoiceRecordingIndicator() {
            const indicator = document.getElementById('voice-recording-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Process audio recording
        async function processAudioRecording(audioBlob) {
            showTypingIndicator();
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                
                const response = await fetch('/transcribe_audio', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.transcript) {
                    addMessage("Bot", `${data.message}\n\n"${data.transcript}"`);
                    // Use the transcript as input
                    input.value = data.transcript;
                    handleInputTyping();
                } else if (data.error) {
                    addMessage("Bot", `Sorry, I couldn't process the voice message: ${data.error}`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage("Bot", "Sorry, I couldn't process the voice message. Please try again or type your message.");
            }
        }

        // Open image in modal
        function openImageModal(imageSrc) {
            modalImage.src = imageSrc;
            imageModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close image modal
        function closeImageModal() {
            imageModal.classList.remove('active');
            document.body.style.overflow = 'auto';
            setTimeout(() => {
                modalImage.src = '';
            }, 300);
        }

        // Create avatar element
        function createAvatar(sender, imageUrl) {
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `${sender} avatar`;
            img.onerror = function() {
                this.style.display = 'none';
                const fallback = document.createElement('div');
                fallback.className = 'avatar-fallback';
                fallback.textContent = sender === 'User' ? 'U' : 'J';
                avatarDiv.appendChild(fallback);
            };
            
            avatarDiv.appendChild(img);
            return avatarDiv;
        }

        // Generate unique chat ID
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Get all chats list
        function getChatsList() {
            const chats = JSON.parse(localStorage.getItem('netragpt_chats') || '[]');
            return chats.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
        }

        // Save chats list
        function saveChatsList(chats) {
            localStorage.setItem('netragpt_chats', JSON.stringify(chats));
        }

        // Generate chat title from first message
        function generateChatTitle(message) {
            const words = message.split(' ').slice(0, 5).join(' ');
            return words.length > 30 ? words.substring(0, 30) + '...' : words;
        }

        // Update chat in list
        function updateChatInList(chatId, message = '', isNew = false) {
            const chats = getChatsList();
            let existingChat = chats.find(chat => chat.id === chatId);
            
            if (existingChat) {
                existingChat.lastActivity = new Date().toISOString();
                if (message) {
                    existingChat.lastMessage = message.substring(0, 100) + (message.length > 100 ? '...' : '');
                }
            } else {
                const newChat = {
                    id: chatId,
                    title: generateChatTitle(message) || 'New Chat',
                    lastMessage: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                    lastActivity: new Date().toISOString(),
                    messageCount: 1
                };
                chats.unshift(newChat);
                existingChat = newChat;
            }
            
            saveChatsList(chats);
            updateChatsList();
            return existingChat;
        }

        // Update chats list display
        function updateChatsList() {
            const chats = getChatsList();
            chatsList.innerHTML = '';

            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div class="no-chats">
                        <i class="fas fa-comment-slash"></i>
                        <div>No conversations yet</div>
                        <div style="font-size: 12px; margin-top: 8px;">Start a new chat to begin!</div>
                    </div>
                `;
                return;
            }

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                chatItem.innerHTML = `
                    <div class="chat-item-header">
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-date">${formatDate(chat.lastActivity)}</div>
                    </div>
                    <div class="chat-preview">${chat.lastMessage || 'No messages yet'}</div>
                `;
                chatItem.onclick = () => switchToChat(chat.id);
                chatsList.appendChild(chatItem);
            });
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Switch to different chat
        function switchToChat(chatId) {
            currentChatId = chatId;
            loadChatHistory(chatId);
            closeSidebar();
            showToast('Chat loaded!');
        }

        // Create new chat
        function createNewChat() {
            currentChatId = generateChatId();
            updateChatInList(currentChatId, '', true);
            loadChatHistory(currentChatId);
            showToast('New chat started!');
        }

        // Show sidebar
        function showSidebar() {
            chatsSidebar.classList.add('active');
            updateChatsList();
        }

        // Close sidebar
        function closeSidebar() {
            chatsSidebar.classList.remove('active');
        }

        // Auto-resize textarea
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // Process message content for special formatting
        function processMessageContent(text) {
            // Convert URLs to clickable links
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="message-link">$1</a>');
            
            // Process LaTeX equations
            text = text.replace(/!\[Equation\]\((data:image\/png;base64,[^)]+)\)/g, function(match, imageData) {
                return `<div class="latex-equation">
                    <img src="${imageData}" alt="LaTeX Equation">
                </div>`;
            });
            
            // Process mathematical visualizations
            text = text.replace(/!\[(.*?)\]\((data:image\/png;base64,[^)]+)\)/g, function(match, altText, imageData) {
                return `<div class="math-visualization">
                    <div class="visualization-title">${altText}</div>
                    <img src="${imageData}" alt="${altText}">
                </div>`;
            });
            
            // Process math results
            text = text.replace(/\*\*ðŸ§® CALCULATIONS:\*\*\s*```\s*([^`]+)\s*```/g, function(match, calculation) {
                return `<div class="math-result">${calculation}</div>`;
            });
            
            // Convert code blocks with enhanced features
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, language, code) {
                const lang = language || 'text';
                const codeId = 'code_' + Date.now();
                return `<div class="code-block">
                    <div class="code-header">
                        <span class="code-language">
                            <i class="fas fa-code"></i> ${lang.toUpperCase()}
                        </span>
                        <div class="code-actions">
                            ${lang !== 'text' ? `<button class="code-btn run-btn" onclick="runCode('${codeId}')">
                                <i class="fas fa-play"></i> Run
                            </button>` : ''}
                            <button class="code-btn copy-btn" onclick="copyCode('${codeId}')">
                                <i class="far fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    <div class="code-content">
                        <pre id="${codeId}"><code>${escapeHtml(code)}</code></pre>
                    </div>
                </div>`;
            });
            
            // Convert inline code
            text = text.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            // Convert line breaks
            text = text.replace(/\n/g, '<br>');
            
            // Process bold text
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            return text;
        }

        // Format math expressions with proper symbols
        function formatMathExpression(expression) {
            // Replace operators with proper symbols
            expression = expression.replace(/\*/g, 'Ã—');
            expression = expression.replace(/\//g, 'Ã·');
            expression = expression.replace(/sqrt\(/g, 'âˆš(');
            
            // Handle percentage calculations
            expression = expression.replace(/(\d+)%/g, '$1%');
            
            return expression;
        }

        // Escape HTML for code blocks
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Run code (simulated)
        function runCode(codeId) {
            const codeElement = document.getElementById(codeId);
            if (!codeElement) return;
            
            const code = codeElement.textContent;
            const language = 'python'; // Default for demo
            
            showToast(`Running ${language.toUpperCase()} code...`);
            
            // Simulate code execution
            setTimeout(() => {
                const output = simulateCodeExecution(code, language);
                addMessage('Bot', `**Code Execution Result**\n\n**Language**: ${language}\n**Output**:\n\`\`\`\n${output}\n\`\`\``);
            }, 1000);
        }

        // Simulate code execution
        function simulateCodeExecution(code, language) {
            if (language === 'python') {
                if (code.includes('print(')) {
                    return 'Hello from Python!\nCode executed successfully.';
                } else if (code.includes('def ')) {
                    return 'Function defined successfully.\nNo output generated (function not called).';
                }
            }
            return 'Code executed successfully.\nNo visible output generated.';
        }

        // Copy code to clipboard
        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            if (!codeElement) return;
            
            const code = codeElement.textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied to clipboard! ðŸ“‹');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy code. Please try again.');
            });
        }

        // Add message with enhanced features
        function addMessage(sender, text, imageUrl = null, audioUrl = null) {
            if (!isSessionActive && sender === 'User') {
                showToast('Session expired. Please start a new session.');
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender.toLowerCase());
            
            // Create avatar
            const avatar = createAvatar(sender, sender === 'User' ? USER_AVATAR : JOVIRA_AVATAR);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            
            // Process content for special formatting
            const processedContent = processMessageContent(text);
            contentDiv.innerHTML = processedContent;
            
            // Add image if available
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                if (sender === 'User') {
                    img.classList.add('uploaded-image');
                    img.alt = 'Uploaded image';
                    img.onclick = () => openImageModal(imageUrl);
                } else {
                    img.classList.add('message-image');
                    img.alt = 'Generated image';
                    img.onclick = () => openImageModal(imageUrl);
                }
                contentDiv.appendChild(img);
            }
            
            // Add audio if available
            if (audioUrl) {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioUrl;
                audio.style.width = '100%';
                audio.style.marginTop = '8px';
                contentDiv.appendChild(audio);
            }
            
            // Add timestamp
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = timeString;
            contentDiv.appendChild(timeSpan);
            
            // Add elements to message
            if (sender === 'User') {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
            }
            
            chatBox.appendChild(messageDiv);
            
            // Smooth scroll to bottom
            chatBox.scrollTo({
                top: chatBox.scrollHeight,
                behavior: 'smooth'
            });
            
            // Save to localStorage
            saveMessageToHistory(sender, text, imageUrl, audioUrl);
            
            // Process MathJax for LaTeX rendering
            if (window.MathJax) {
                MathJax.typesetPromise([contentDiv]).catch((err) => {
                    console.log('MathJax typeset error:', err);
                });
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            if (isTyping) return;
            
            isTyping = true;
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message-typing');
            typingDiv.id = 'typing-indicator';
            
            const avatar = createAvatar('Bot', JOVIRA_AVATAR);
            
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span>Jovira is typing...</span>
            `;
            
            typingDiv.prepend(avatar);
            chatBox.appendChild(typingDiv);
            chatBox.scrollTo({
                top: chatBox.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Save message to history
        function saveMessageToHistory(sender, text, imageUrl = null, audioUrl = null) {
            const chatHistory = JSON.parse(localStorage.getItem(currentChatId) || '[]');
            chatHistory.push({
                sender,
                text,
                imageUrl,
                audioUrl,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(currentChatId, JSON.stringify(chatHistory));
            
            // Update chat list
            if (sender === 'User') {
                updateChatInList(currentChatId, text);
            }
        }

        // Load chat history
        function loadChatHistory(chatId) {
            const chatHistory = JSON.parse(localStorage.getItem(chatId) || '[]');
            chatBox.innerHTML = '';
            
            // Add welcome message if no history
            if (chatHistory.length === 0) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.classList.add('welcome-message');
                welcomeMsg.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <h3 style="margin-bottom: 8px; color: var(--whatsapp-black);">Hello! I'm Jovira</h3>
                    <p style="margin-bottom: 15px; line-height: 1.5;">Your intelligent assistant from Aidnest Africa! What would you like to know?</p>
                    
                    <div class="quick-actions">
                        <div class="quick-action" onclick="askQuestion('Calculate 25 Ã— 4 + 15')">
                            <i class="fas fa-calculator"></i> Math
                        </div>
                        <div class="quick-action" onclick="askQuestion('Show me Python code for a calculator')">
                            <i class="fas fa-code"></i> Code
                        </div>
                        <div class="quick-action" onclick="askQuestion('Tell me about Netra services')">
                            <i class="fas fa-mobile-alt"></i> Netra
                        </div>
                        <div class="quick-action" onclick="askQuestion('What is 15% of 200?')">
                            <i class="fas fa-percentage"></i> Percentage
                        </div>
                    </div>
                `;
                chatBox.appendChild(welcomeMsg);
            }
            
            // Load messages
            chatHistory.forEach(msg => {
                addMessage(msg.sender, msg.text, msg.imageUrl, msg.audioUrl);
            });
        }

        // Clear current chat
        function clearCurrentChat() {
            if (confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
                chatBox.innerHTML = '';
                loadWelcomeMessage();
                showToast('Chat cleared! ðŸ—‘ï¸');
            }
        }

        // Load welcome message
        function loadWelcomeMessage() {
            // Welcome message is already in HTML
        }

        // Ask question from quick action
        function askQuestion(question) {
            input.value = question;
            sendMessage();
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Send message function
        async function sendMessage() {
            const msg = input.value.trim();
            if (!msg) return;

            if (!isSessionActive) {
                showToast('Session expired. Please start a new session.');
                return;
            }

            addMessage("User", msg);
            input.value = '';
            input.style.height = 'auto';
            sendBtn.disabled = true;
            inputWrapper.classList.remove('typing');

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: msg, chatId: currentChatId })
                });

                const data = await response.json();
                hideTypingIndicator();
                
                if (data.session_expired) {
                    endSession();
                    addMessage("Bot", data.reply);
                } else {
                    addMessage("Bot", data.reply);
                    
                    // Update session status if provided
                    if (data.time_remaining !== undefined) {
                        updateTimerDisplay();
                    }
                    
                    // Show session warning if provided
                    if (data.session_warning) {
                        showToast(data.session_warning);
                    }
                }
            } catch (err) {
                hideTypingIndicator();
                addMessage("Bot", "I'm having trouble connecting right now. Please check your internet connection and try again. ");
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Handle math calculations
        function handleMathCalculation(question) {
            try {
                // Extract numbers and operators
                const numbers = question.match(/\d+(\.\d+)?/g);
                const operators = question.match(/[\+\-\*\/\Ã—\Ã·\%]/g);
                
                if (!numbers || numbers.length < 2) {
                    return "I need at least two numbers to perform a calculation. Please provide a valid mathematical expression.";
                }
                
                // Convert to numbers
                const num1 = parseFloat(numbers[0]);
                const num2 = parseFloat(numbers[1]);
                
                let result, expression;
                
                // Determine operation based on question
                if (question.includes('+') || question.toLowerCase().includes('add')) {
                    result = num1 + num2;
                    expression = `${num1} + ${num2}`;
                } else if (question.includes('-') || question.toLowerCase().includes('subtract') || question.toLowerCase().includes('minus')) {
                    result = num1 - num2;
                    expression = `${num1} - ${num2}`;
                } else if (question.includes('*') || question.includes('Ã—') || question.toLowerCase().includes('multiply') || question.toLowerCase().includes('times')) {
                    result = num1 * num2;
                    expression = `${num1} Ã— ${num2}`;
                } else if (question.includes('/') || question.includes('Ã·') || question.toLowerCase().includes('divide') || question.toLowerCase().includes('over')) {
                    if (num2 === 0) {
                        return "Division by zero is not allowed. Please provide a valid divisor.";
                    }
                    result = num1 / num2;
                    expression = `${num1} Ã· ${num2}`;
                } else if (question.includes('%') || question.toLowerCase().includes('percent') || question.toLowerCase().includes('percentage')) {
                    result = (num1 * num2) / 100;
                    expression = `${num2}% of ${num1}`;
                } else {
                    return "I can perform addition (+), subtraction (-), multiplication (Ã—), division (Ã·), and percentage calculations. Please specify the operation.";
                }
                
                return `**Calculation:**\n\`\`\`\n${expression}\n\`\`\`\n\n**Result:**\n\`\`\`\n${result}\n\`\`\``;
                
            } catch (error) {
                return "I couldn't process that mathematical expression. Please try a different format, like 'Calculate 25 Ã— 4 + 15' or 'What is 15% of 200?'";
            }
        }

        // Initialize chat
        function initializeChat() {
            initializeChatSystem();
        }

        // Event listeners
        sendBtn.onclick = sendMessage;

        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        closeSidebarBtn.addEventListener('click', closeSidebar);

        // Close sidebar when clicking outside on mobile
        chatsSidebar.addEventListener('click', (e) => {
            if (e.target === chatsSidebar) {
                closeSidebar();
            }
        });

        // Load chat on startup
        window.addEventListener('load', initializeChat);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                input.focus();
            }
        });

        // Handle logo loading
        const logoImg = document.querySelector('.user-avatar img');
        if (logoImg) {
            logoImg.onload = function() {
                this.style.display = 'block';
                this.nextElementSibling.style.display = 'none';
            };
            logoImg.onerror = function() {
                this.style.display = 'none';
                this.nextElementSibling.style.display = 'flex';
            };
        }

        // View chat history function
        function viewChatHistory() {
            showSidebar();
        }
    </script>
</body>
</html>