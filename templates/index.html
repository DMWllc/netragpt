<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jovira - Your Intelligent Assistant</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
    :root {
        --primary-color: #25D366;
        --primary-dark: #128C7E;
        --primary-darker: #075E54;
        --accent-color: #34B7F1;
        --background-dark: #000033;
        --surface-dark: #0a0a3a;
        --surface-light: #1a1a4a;
        --text-primary: #ffffff;
        --text-secondary: #b8b8d6;
        --text-accent: #a78bfa;
        --border-radius: 12px;
        --border-radius-small: 8px;
        --transition: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--background-dark);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        color: var(--text-primary);
        overflow: hidden;
        padding: 0;
        position: relative;
    }

    /* Main Chat Container */
    .chat-container {
        background: var(--surface-dark);
        width: 100%;
        max-width: 450px;
        height: 100vh;
        max-height: 850px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Chat background with wallpaper */
    .chat-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://myaidnest.com/images/netrawallpaper.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0.15;
        z-index: 0;
    }

    /* Header */
    .chat-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
        color: white;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        z-index: 10;
        position: relative;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .back-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: none;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: var(--primary-color);
    }

    .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-fallback {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        color: white;
    }

    .user-details h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 2px;
    }

    .user-details p {
        font-size: 12px;
        opacity: 0.9;
        color: rgba(255, 255, 255, 0.8);
    }

    .header-right {
        display: flex;
        gap: 8px;
    }

    .header-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: var(--transition);
        backdrop-filter: blur(10px);
    }

    .header-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.1);
    }

    /* Chat Content */
    .chat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    #chat {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scroll-behavior: smooth;
        position: relative;
        z-index: 1;
    }

    #chat::-webkit-scrollbar {
        width: 6px;
    }

    #chat::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    #chat::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
    }

    /* Messages */
    .message {
        display: flex;
        margin-bottom: 4px;
        animation: messageSlide 0.3s ease-out;
        gap: 10px;
        align-items: flex-start;
        max-width: 85%;
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message.bot {
        align-self: flex-start;
    }

    .message-avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        flex-shrink: 0;
        overflow: hidden;
        margin-top: 2px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .message.user .message-avatar {
        background: var(--primary-color);
    }

    .message.bot .message-avatar {
        background: var(--accent-color);
    }

    .message-content {
        padding: 12px 16px;
        border-radius: var(--border-radius);
        font-size: 14px;
        line-height: 1.5;
        position: relative;
        transition: var(--transition);
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        max-width: 100%;
        backdrop-filter: blur(10px);
    }

    .message.user .message-content {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.bot .message-content {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        
        /* Scrollable properties */
        overflow-x: auto;
        overflow-y: auto;
        max-height: 500px;
        max-width: 100%;
        word-wrap: break-word;
        white-space: pre-wrap;
    }

    /* Custom scrollbar for messages */
    .message.bot .message-content::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .message.bot .message-content::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    .message.bot .message-content::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
    }

    .message-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.6);
        text-align: right;
        margin-top: 6px;
        display: block;
    }

    .message.user .message-time {
        text-align: right;
    }

    .message.bot .message-time {
        text-align: left;
    }

    /* Uploaded Images */
    .uploaded-image {
        max-width: 100%;
        max-height: 250px;
        border-radius: var(--border-radius-small);
        margin-top: 8px;
        cursor: pointer;
        transition: var(--transition);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .uploaded-image:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    /* Voice Recording */
    .voice-recording {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        border-radius: var(--border-radius);
        margin: 8px 0;
        animation: pulse 1.5s infinite;
        color: white;
        box-shadow: 0 4px 16px rgba(37, 211, 102, 0.3);
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .voice-visualizer {
        display: flex;
        gap: 3px;
        align-items: center;
        flex: 1;
    }

    .voice-bar {
        width: 3px;
        background: white;
        border-radius: 2px;
        animation: voicePulse 0.8s infinite ease-in-out;
    }

    .voice-bar:nth-child(1) { animation-delay: 0s; height: 8px; }
    .voice-bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
    .voice-bar:nth-child(3) { animation-delay: 0.2s; height: 16px; }
    .voice-bar:nth-child(4) { animation-delay: 0.3s; height: 12px; }
    .voice-bar:nth-child(5) { animation-delay: 0.4s; height: 8px; }

    @keyframes voicePulse {
        0%, 100% { transform: scaleY(0.8); }
        50% { transform: scaleY(1.2); }
    }

    /* Links Styling */
    .message-link {
        color: var(--text-accent);
        text-decoration: none;
        border-bottom: 1px solid var(--text-accent);
        transition: var(--transition);
        padding: 2px 4px;
        border-radius: 4px;
    }

    .message-link:hover {
        background: var(--text-accent);
        color: var(--background-dark);
    }

    /* Enhanced Code Blocks */
    .code-block {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-small);
        padding: 0;
        margin: 12px 0;
        position: relative;
        font-family: 'Fira Code', monospace;
        font-size: 13px;
        line-height: 1.4;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .code-language {
        color: var(--primary-color);
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .code-actions {
        display: flex;
        gap: 8px;
    }

    .code-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-secondary);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 11px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .code-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    .code-btn.run-btn {
        background: var(--primary-color);
        color: white;
    }

    .code-btn.copy-btn {
        background: var(--accent-color);
        color: white;
    }

    .code-content {
        padding: 14px;
        color: var(--text-primary);
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
    }

    .code-content pre {
        margin: 0;
        font-family: 'Fira Code', monospace;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .code-keyword { color: #ff79c6; }
    .code-string { color: #f1fa8c; }
    .code-number { color: #bd93f9; }
    .code-comment { color: #6272a4; font-style: italic; }
    .code-function { color: #50fa7b; }
    .code-operator { color: #ff79c6; }
    .code-variable { color: #8be9fd; }
    .code-class { color: #8be9fd; font-weight: bold; }

    /* Inline Code */
    .inline-code {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        padding: 2px 6px;
        font-family: 'Fira Code', monospace;
        font-size: 12px;
        color: var(--primary-color);
    }

    /* Math Expression Styling */
    .math-expression {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-small);
        padding: 14px;
        margin: 8px 0;
        text-align: center;
        font-size: 16px;
        font-family: 'Fira Code', monospace;
    }

    .math-result {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 12px 16px;
        border-radius: var(--border-radius-small);
        margin: 8px 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'Fira Code', monospace;
        box-shadow: 0 4px 16px rgba(37, 211, 102, 0.3);
    }

    /* Typing Indicator */
    .message-typing {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 18px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius);
        border-bottom-left-radius: 4px;
        max-width: 85%;
        align-self: flex-start;
        color: var(--text-secondary);
        font-size: 13px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--primary-color);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Welcome Message */
    .welcome-message {
        text-align: center;
        padding: 24px;
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius);
        margin: 10px 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
    }

    .welcome-message i {
        font-size: 36px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Chat Input */
    .chat-input-area {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        background: var(--surface-dark);
        padding: 12px 16px;
        position: relative;
        z-index: 10;
        backdrop-filter: blur(10px);
    }

    .chat-input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        padding: 8px 14px;
        transition: var(--transition);
        backdrop-filter: blur(10px);
    }

    .chat-input-wrapper:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        background: rgba(255, 255, 255, 0.15);
    }

    .input-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0;
    }

    .file-input-wrapper {
        position: relative;
    }

    .file-input {
        position: absolute;
        left: -9999px;
        opacity: 0;
    }

    .input-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 38px;
        height: 38px;
    }

    .input-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .voice-btn.recording {
        background: #ff4757;
        color: white;
        animation: pulse 1.5s infinite;
    }

    #input {
        flex: 1;
        border: none;
        font-size: 14px;
        background: transparent;
        color: var(--text-primary);
        transition: var(--transition);
        resize: none;
        min-height: 22px;
        max-height: 100px;
        font-family: inherit;
        line-height: 1.4;
        padding: 8px 0;
        outline: none;
    }

    #input:focus {
        outline: none;
    }

    #input::placeholder {
        color: var(--text-secondary);
    }

    #send {
        padding: 10px;
        background: var(--primary-color);
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 50%;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
    }

    #send:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(37, 211, 102, 0.5);
    }

    #send:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .send-icon {
        width: 16px;
        height: 16px;
    }

    /* Session Timer */
    .session-timer {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--surface-dark);
        color: var(--text-primary);
        padding: 8px 16px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        min-width: 200px;
        z-index: 10;
        transition: var(--transition);
        backdrop-filter: blur(10px);
    }

    .timer-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .timer-progress {
        flex: 1;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin: 0 10px;
    }

    .timer-progress-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
        background: var(--primary-color);
    }

    .timer-actions {
        display: flex;
        gap: 6px;
    }

    .timer-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: var(--text-primary);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        cursor: pointer;
        transition: var(--transition);
    }

    .timer-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
        body {
            padding: 0;
        }
        
        .chat-container {
            height: 100vh;
            max-width: none;
            border-radius: 0;
        }

        .chat-header {
            padding: 10px 12px;
        }

        #chat {
            padding: 15px;
        }

        .message-content {
            max-width: 80%;
            padding: 10px 14px;
        }

        .chat-input-area {
            padding: 10px 12px;
        }
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
</head>
<body>
    <!-- Main Chat Container -->
    <div class="chat-container">
        <!-- Chat background with wallpaper -->
        <div class="chat-background"></div>

        <!-- Session Timer Bar -->
        <div class="session-timer" id="sessionTimer">
            <div class="timer-info">
                <i class="fas fa-clock"></i>
                <span id="timerText">20:00</span>
            </div>
            <div class="timer-progress">
                <div class="timer-progress-bar" id="timerProgress" style="width: 100%;"></div>
            </div>
            <div class="timer-actions">
                <button class="timer-btn" id="extendSession" title="Extend Session">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="timer-btn" id="pauseSession" title="Pause Session">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
        </div>

        <div class="chat-header">
            <div class="header-left">
                <button class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="user-info">
                    <div class="user-avatar">
                        <img src="https://myaidnest.com/images/jovira.png" alt="Jovira" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback" style="display: none;">J</div>
                    </div>
                    <div class="user-details">
                        <h3>Jovira</h3>
                        <p>Online</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="videoCallBtn" title="Video Call">
                    <i class="fas fa-video"></i>
                </button>
                <button class="header-btn" id="voiceCallBtn" title="Voice Call">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="header-btn" id="menuBtn" title="Menu">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-content">
            <div id="chat">
                <!-- Welcome message will be dynamically added for new chats -->
            </div>
        </div>

        <div class="chat-input-area">
            <div class="chat-input-wrapper" id="inputWrapper">
                <div class="input-controls">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageUpload" accept="image/*" class="file-input">
                        <button class="input-btn" id="imageBtn" title="Upload Image">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <button class="input-btn" id="emojiBtn" title="Emoji">
                        <i class="far fa-smile"></i>
                    </button>
                </div>
                <textarea id="input" placeholder="Type a message..." rows="1"></textarea>
                <div class="input-controls">
                    <button class="input-btn voice-btn" id="voiceBtn" title="Voice Message">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="send">
                        <i class="fas fa-paper-plane send-icon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatBox = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const backBtn = document.getElementById('backBtn');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const voiceCallBtn = document.getElementById('voiceCallBtn');
        const menuBtn = document.getElementById('menuBtn');
        const imageUpload = document.getElementById('imageUpload');
        const imageBtn = document.getElementById('imageBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const inputWrapper = document.getElementById('inputWrapper');
        const sessionTimer = document.getElementById('sessionTimer');
        const timerText = document.getElementById('timerText');
        const timerProgress = document.getElementById('timerProgress');
        const extendSessionBtn = document.getElementById('extendSession');
        const pauseSessionBtn = document.getElementById('pauseSession');

        // Profile images
        const JOVIRA_AVATAR = 'https://myaidnest.com/images/jovira.png';
        const USER_AVATAR = 'https://myaidnest.com/images/user.png';

        // State
        let currentChatId = null;
        let isTyping = false;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let isSessionActive = true;
        let sessionTimeRemaining = 20 * 60; // 20 minutes in seconds
        let sessionTimerInterval = null;
        let isSessionPaused = false;
        let hasUserSentMessage = false;

        // Initialize chat system
        function initializeChatSystem() {
            const savedChats = getChatsList();
            if (savedChats.length === 0) {
                createNewChat();
            } else {
                currentChatId = savedChats[0].id;
                loadChatHistory(currentChatId);
            }
            setupEventListeners();
            initializeSessionManagement();
        }

        // Show welcome message for new chats
        function showWelcomeMessage() {
            const chatHistory = JSON.parse(localStorage.getItem(currentChatId) || '[]');
            
            // Only show welcome message if this is a new chat (no messages)
            if (chatHistory.length === 0 && !hasUserSentMessage) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.classList.add('welcome-message');
                welcomeMsg.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <h3 style="margin-bottom: 12px;">Hello! I'm Jovira </h3>
                    <p style="margin-bottom: 16px; line-height: 1.5; color: var(--text-secondary);">
                        Your intelligent assistant from Aidnest Africa! I'm here to help you with anything you need.
                    </p>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 16px;">
                        Built by <strong>Nowamaani Donath</strong>
                    </p>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        Ask me anything about technology, coding, or our services! 
                    </p>
                `;
                chatBox.appendChild(welcomeMsg);
            }
        }

        // Remove welcome message when user sends first message
        function removeWelcomeMessage() {
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            hasUserSentMessage = true;
        }

        // Initialize session management
        function initializeSessionManagement() {
            const savedSession = localStorage.getItem('jovira_session');
            if (savedSession) {
                const sessionData = JSON.parse(savedSession);
                if (sessionData.expires > Date.now()) {
                    sessionTimeRemaining = Math.floor((sessionData.expires - Date.now()) / 1000);
                    isSessionActive = true;
                    startSessionTimer();
                } else {
                    isSessionActive = false;
                    sessionTimer.style.display = 'none';
                }
            } else {
                startNewSession();
            }
        }

        // Start new session
        function startNewSession() {
            isSessionActive = true;
            sessionTimeRemaining = 20 * 60;
            sessionTimer.style.display = 'flex';
            
            const sessionData = {
                expires: Date.now() + (sessionTimeRemaining * 1000)
            };
            localStorage.setItem('jovira_session', JSON.stringify(sessionData));
            
            startSessionTimer();
            updateTimerDisplay();
            showToast('New session started! ðŸŽ‰');
        }

        // Start session timer
        function startSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }
            
            sessionTimerInterval = setInterval(() => {
                if (!isSessionPaused && isSessionActive) {
                    sessionTimeRemaining--;
                    updateTimerDisplay();
                    
                    if (sessionTimeRemaining <= 0) {
                        endSession();
                    }
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(sessionTimeRemaining / 60);
            const seconds = sessionTimeRemaining % 60;
            timerText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const progressPercentage = (sessionTimeRemaining / (20 * 60)) * 100;
            timerProgress.style.width = `${progressPercentage}%`;
            
            if (progressPercentage <= 25) {
                timerProgress.style.background = '#ff4757';
            } else if (progressPercentage <= 50) {
                timerProgress.style.background = '#ffa502';
            } else {
                timerProgress.style.background = 'var(--primary-color)';
            }
        }

        // End session
        function endSession() {
            isSessionActive = false;
            clearInterval(sessionTimerInterval);
            sessionTimer.style.display = 'none';
            localStorage.removeItem('jovira_session');
            showToast('Session ended. Start a new session to continue.');
        }

        // Extend session
        function extendSession() {
            if (isSessionActive) {
                sessionTimeRemaining += 10 * 60;
                updateTimerDisplay();
                
                const sessionData = {
                    expires: Date.now() + (sessionTimeRemaining * 1000)
                };
                localStorage.setItem('jovira_session', JSON.stringify(sessionData));
                
                showToast('Session extended by 10 minutes! â°');
            }
        }

        // Toggle session pause
        function toggleSessionPause() {
            isSessionPaused = !isSessionPaused;
            
            if (isSessionPaused) {
                pauseSessionBtn.innerHTML = '<i class="fas fa-play"></i>';
                pauseSessionBtn.title = 'Resume Session';
                showToast('Session paused');
            } else {
                pauseSessionBtn.innerHTML = '<i class="fas fa-pause"></i>';
                pauseSessionBtn.title = 'Pause Session';
                showToast('Session resumed');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            imageBtn.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleImageUpload);
            
            voiceBtn.addEventListener('click', toggleVoiceRecording);
            
            input.addEventListener('input', handleInputTyping);
            input.addEventListener('focus', () => {
                inputWrapper.classList.add('typing');
            });
            input.addEventListener('blur', () => {
                if (!input.value.trim()) {
                    inputWrapper.classList.remove('typing');
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    input.focus();
                }
            });

            extendSessionBtn.addEventListener('click', extendSession);
            pauseSessionBtn.addEventListener('click', toggleSessionPause);
        }

        // Handle input typing state
        function handleInputTyping() {
            if (input.value.trim()) {
                inputWrapper.classList.add('typing');
            } else {
                inputWrapper.classList.remove('typing');
            }
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file!');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size should be less than 5MB!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                addMessage("User", "I uploaded an image for analysis:", imageData);
                analyzeImage(file);
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        // Analyze uploaded image
        async function analyzeImage(file) {
            showTypingIndicator();
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/analyze_image', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.analysis) {
                    addMessage("Bot", `${data.message}\n\n${data.analysis}`);
                } else if (data.error) {
                    addMessage("Bot", `Sorry, I encountered an error while analyzing the image: ${data.error}`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage("Bot", "Sorry, I encountered an error while analyzing the image. Please try again.");
            }
        }

        // Voice recording functionality
        async function toggleVoiceRecording() {
            if (!isRecording) {
                await startVoiceRecording();
            } else {
                stopVoiceRecording();
            }
        }

        // Start voice recording
        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudioRecording(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                addVoiceRecordingIndicator();
                
            } catch (error) {
                console.error('Error starting voice recording:', error);
                showToast('Microphone access denied or not available');
            }
        }

        // Stop voice recording
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                removeVoiceRecordingIndicator();
            }
        }

        // Add voice recording indicator
        function addVoiceRecordingIndicator() {
            const recordingDiv = document.createElement('div');
            recordingDiv.className = 'voice-recording';
            recordingDiv.id = 'voice-recording-indicator';
            recordingDiv.innerHTML = `
                <i class="fas fa-microphone"></i>
                <div class="voice-visualizer">
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                </div>
                <span>Recording... Click stop when done</span>
            `;
            chatBox.appendChild(recordingDiv);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        // Remove voice recording indicator
        function removeVoiceRecordingIndicator() {
            const indicator = document.getElementById('voice-recording-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Process audio recording
        async function processAudioRecording(audioBlob) {
            showTypingIndicator();
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                
                const response = await fetch('/transcribe_audio', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.transcript) {
                    addMessage("Bot", `${data.message}\n\n"${data.transcript}"`);
                    input.value = data.transcript;
                    handleInputTyping();
                } else if (data.error) {
                    addMessage("Bot", `Sorry, I couldn't process the voice message: ${data.error}`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage("Bot", "Sorry, I couldn't process the voice message. Please try again or type your message.");
            }
        }

        // Create avatar element
        function createAvatar(sender, imageUrl) {
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `${sender} avatar`;
            img.onerror = function() {
                this.style.display = 'none';
                const fallback = document.createElement('div');
                fallback.className = 'avatar-fallback';
                fallback.textContent = sender === 'User' ? 'U' : 'J';
                avatarDiv.appendChild(fallback);
            };
            
            avatarDiv.appendChild(img);
            return avatarDiv;
        }

        // Generate unique chat ID
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Get all chats list
        function getChatsList() {
            const chats = JSON.parse(localStorage.getItem('netragpt_chats') || '[]');
            return chats.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
        }

        // Save chats list
        function saveChatsList(chats) {
            localStorage.setItem('netragpt_chats', JSON.stringify(chats));
        }

        // Generate chat title from first message
        function generateChatTitle(message) {
            const words = message.split(' ').slice(0, 5).join(' ');
            return words.length > 30 ? words.substring(0, 30) + '...' : words;
        }

        // Update chat in list
        function updateChatInList(chatId, message = '', isNew = false) {
            const chats = getChatsList();
            let existingChat = chats.find(chat => chat.id === chatId);
            
            if (existingChat) {
                existingChat.lastActivity = new Date().toISOString();
                if (message) {
                    existingChat.lastMessage = message.substring(0, 100) + (message.length > 100 ? '...' : '');
                }
            } else {
                const newChat = {
                    id: chatId,
                    title: generateChatTitle(message) || 'New Chat',
                    lastMessage: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                    lastActivity: new Date().toISOString(),
                    messageCount: 1
                };
                chats.unshift(newChat);
                existingChat = newChat;
            }
            
            saveChatsList(chats);
            return existingChat;
        }

        // Create new chat
        function createNewChat() {
            currentChatId = generateChatId();
            updateChatInList(currentChatId, '', true);
            loadChatHistory(currentChatId);
            showToast('New chat started!');
        }

        // Auto-resize textarea
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // Process message content for special formatting
        function processMessageContent(text) {
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="message-link">$1</a>');
            
            text = text.replace(/!\[Equation\]\((data:image\/png;base64,[^)]+)\)/g, function(match, imageData) {
                return `<div class="latex-equation">
                    <img src="${imageData}" alt="LaTeX Equation">
                </div>`;
            });
            
            text = text.replace(/!\[(.*?)\]\((data:image\/png;base64,[^)]+)\)/g, function(match, altText, imageData) {
                return `<div class="math-visualization">
                    <div class="visualization-title">${altText}</div>
                    <img src="${imageData}" alt="${altText}">
                </div>`;
            });
            
            text = text.replace(/\*\*ðŸ§® CALCULATIONS:\*\*\s*```\s*([^`]+)\s*```/g, function(match, calculation) {
                return `<div class="math-result">${calculation}</div>`;
            });
            
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, language, code) {
                const lang = language || 'text';
                const codeId = 'code_' + Date.now();
                return `<div class="code-block">
                    <div class="code-header">
                        <span class="code-language">
                            <i class="fas fa-code"></i> ${lang.toUpperCase()}
                        </span>
                        <div class="code-actions">
                            ${lang !== 'text' ? `<button class="code-btn run-btn" onclick="runCode('${codeId}')">
                                <i class="fas fa-play"></i> Run
                            </button>` : ''}
                            <button class="code-btn copy-btn" onclick="copyCode('${codeId}')">
                                <i class="far fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    <div class="code-content">
                        <pre id="${codeId}"><code>${escapeHtml(code)}</code></pre>
                    </div>
                </div>`;
            });
            
            text = text.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            return text;
        }

        // Escape HTML for code blocks
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Run code (simulated)
        function runCode(codeId) {
            const codeElement = document.getElementById(codeId);
            if (!codeElement) return;
            
            const code = codeElement.textContent;
            const language = 'python';
            
            showToast(`Running ${language.toUpperCase()} code...`);
            
            setTimeout(() => {
                const output = simulateCodeExecution(code, language);
                addMessage('Bot', `**Code Execution Result**\n\n**Language**: ${language}\n**Output**:\n\`\`\`\n${output}\n\`\`\``);
            }, 1000);
        }

        // Simulate code execution
        function simulateCodeExecution(code, language) {
            if (language === 'python') {
                if (code.includes('print(')) {
                    return 'Hello from Python!\nCode executed successfully.';
                } else if (code.includes('def ')) {
                    return 'Function defined successfully.\nNo output generated (function not called).';
                }
            }
            return 'Code executed successfully.\nNo visible output generated.';
        }

        // Copy code to clipboard
        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            if (!codeElement) return;
            
            const code = codeElement.textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied to clipboard! ðŸ“‹');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy code. Please try again.');
            });
        }

        // Add message with enhanced features
        function addMessage(sender, text, imageUrl = null, audioUrl = null) {
            if (!isSessionActive && sender === 'User') {
                showToast('Session expired. Please start a new session.');
                return;
            }

            // Remove welcome message when user sends first message
            if (sender === 'User' && !hasUserSentMessage) {
                removeWelcomeMessage();
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender.toLowerCase());
            
            const avatar = createAvatar(sender, sender === 'User' ? USER_AVATAR : JOVIRA_AVATAR);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            
            const processedContent = processMessageContent(text);
            contentDiv.innerHTML = processedContent;
            
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                if (sender === 'User') {
                    img.classList.add('uploaded-image');
                    img.alt = 'Uploaded image';
                } else {
                    img.classList.add('message-image');
                    img.alt = 'Generated image';
                }
                contentDiv.appendChild(img);
            }
            
            if (audioUrl) {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioUrl;
                audio.style.width = '100%';
                audio.style.marginTop = '8px';
                contentDiv.appendChild(audio);
            }
            
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = timeString;
            contentDiv.appendChild(timeSpan);
            
            if (sender === 'User') {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
            }
            
            chatBox.appendChild(messageDiv);
            
            chatBox.scrollTo({
                top: chatBox.scrollHeight,
                behavior: 'smooth'
            });
            
            saveMessageToHistory(sender, text, imageUrl, audioUrl);
            
            if (window.MathJax) {
                MathJax.typesetPromise([contentDiv]).catch((err) => {
                    console.log('MathJax typeset error:', err);
                });
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            if (isTyping) return;
            
            isTyping = true;
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message-typing');
            typingDiv.id = 'typing-indicator';
            
            const avatar = createAvatar('Bot', JOVIRA_AVATAR);
            
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span>Jovira is typing...</span>
            `;
            
            typingDiv.prepend(avatar);
            chatBox.appendChild(typingDiv);
            chatBox.scrollTo({
                top: chatBox.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Save message to history
        function saveMessageToHistory(sender, text, imageUrl = null, audioUrl = null) {
            const chatHistory = JSON.parse(localStorage.getItem(currentChatId) || '[]');
            chatHistory.push({
                sender,
                text,
                imageUrl,
                audioUrl,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(currentChatId, JSON.stringify(chatHistory));
            
            if (sender === 'User') {
                updateChatInList(currentChatId, text);
            }
        }

        // Load chat history
        function loadChatHistory(chatId) {
            const chatHistory = JSON.parse(localStorage.getItem(chatId) || '[]');
            chatBox.innerHTML = '';
            
            // Show welcome message only for new chats
            if (chatHistory.length === 0) {
                showWelcomeMessage();
            } else {
                hasUserSentMessage = true;
            }
            
            chatHistory.forEach(msg => {
                addMessage(msg.sender, msg.text, msg.imageUrl, msg.audioUrl);
            });
        }

        // Ask question from quick action
        function askQuestion(question) {
            input.value = question;
            sendMessage();
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Send message function
        async function sendMessage() {
            const msg = input.value.trim();
            if (!msg) return;

            if (!isSessionActive) {
                showToast('Session expired. Please start a new session.');
                return;
            }

            addMessage("User", msg);
            input.value = '';
            input.style.height = 'auto';
            sendBtn.disabled = true;
            inputWrapper.classList.remove('typing');

            showTypingIndicator();

            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: msg, chatId: currentChatId })
                });

                const data = await response.json();
                hideTypingIndicator();
                
                if (data.session_expired) {
                    endSession();
                    addMessage("Bot", data.reply);
                } else {
                    addMessage("Bot", data.reply);
                    
                    if (data.time_remaining !== undefined) {
                        updateTimerDisplay();
                    }
                    
                    if (data.session_warning) {
                        showToast(data.session_warning);
                    }
                }
            } catch (err) {
                hideTypingIndicator();
                addMessage("Bot", "I'm having trouble connecting right now. Please check your internet connection and try again. ");
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Initialize chat
        function initializeChat() {
            initializeChatSystem();
        }

        // Event listeners
        sendBtn.onclick = sendMessage;

        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Load chat on startup
        window.addEventListener('load', initializeChat);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                input.focus();
            }
        });

        // Handle logo loading
        const logoImg = document.querySelector('.user-avatar img');
        if (logoImg) {
            logoImg.onload = function() {
                this.style.display = 'block';
                this.nextElementSibling.style.display = 'none';
            };
            logoImg.onerror = function() {
                this.style.display = 'none';
                this.nextElementSibling.style.display = 'flex';
            };
        }
    </script>
</body>
</html>